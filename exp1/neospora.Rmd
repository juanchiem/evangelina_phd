---
title: "Neospora"
output: html_document
---

```{r setup global del informe, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE, 
                      messages = FALSE)
```

```{r paquetes}
pacman::p_load(tidyverse, lubridate, janitor)
pacman::p_load(GGally, correlation, ggcorrplot, viridis) 
pacman::p_load(cowplot)
pacman::p_load(lme4, performance, skimr, emmeans, multcomp, sjPlot) 
#install.packages("multcompView") # solo una vez y no hace falta cargarlo
conflicted::conflict_prefer("select", "dplyr")
conflicted::conflict_prefer("filter", "dplyr")
```

Contexto: se da minerales y vitaminas asociados a propiedades antioxidantes a vacas en el periodo preparto y se evaluan diferentes variables en el ternero tales como peso vivo durante 9 semanas y luego a los 200 dias de vida aproximadamente ademas de evaluar como la ocurrencia de Neosporosis en la madre al preparto afecto el peso al nacer

## Importacion de datos

```{r}
raw <- rio::import("../exp1/data/neospora_peso.xlsx")%>%
  clean_names()
raw %>% str 
raw %>% head 
```

```{r}
ac_dat <- raw %>% 
  pivot_longer(cols = ac_0:ac_250, 
               names_prefix= "ac_", 
               names_to = "dias", 
               values_to = "ac")  %>% 
  mutate_at(vars(dias), as.numeric) %>% 
  mutate_at(vars(id_ternero, trat, sexo), as.factor) %>% 
  select(id_ternero, trat, sexo, dias, ac) %>% 
  mutate(binom_ac  = ifelse(ac >= 6,1,0)) %>% 
  # filter(ac<100) %>% 
  filter(dias<250) 

ac_dat %>% str
ac_dat %>% 
  group_by(sexo, trat) %>%  
  skim(ac)
```

```{r}
ac_dat %>% 
  # filter(dias<250) %>% 
  # filter(ac<100) %>% 
  ggplot()+
  aes(x=dias, y=ac, col=trat)+
  geom_jitter(width=.2, alpha=.5)+
  facet_wrap("sexo") + 
  geom_line(stat = "summary", fun=mean)+
  # geom_line(stat = "summary", fun=median)+
  # geom_smooth(se=F, method = "lm")+
  theme_bw()+
  geom_hline(yintercept = 6, linetype="dashed") + 
  labs(y="IgG (IRCP)", x = "Días desde nacimiento")
```

```{r}
ac_dat %>% 
  ggplot()+
  aes(x=dias, y=binom_ac, col=trat)+
  geom_point(alpha=.5)+
  facet_wrap("sexo") + 
  geom_smooth(method = "glm", 
              # se=F, 
              method.args = list(family = "binomial"), 
              linetype = "dashed")+
  theme_bw()+
  labs(y="IgG (IRCP)", x = "Días desde nacimiento")
```

Ajustaremos un modelo mixto que contemple las medidas repetidas en el tiempo sobre una misma unidad experimental, para ello le asignamos el efecto aleatorio a la misma.

```{r}
m1 <- glmer(binom_ac ~ dias * trat * sexo + (1|id_ternero), data=ac_dat)
m2 <- glmer(binom_ac ~ dias + trat + sexo + (1|id_ternero), data=ac_dat)
m3 <- glmer(binom_ac ~ dias  + (1|id_ternero), data=ac_dat)
m4 <- glmer(binom_ac ~ trat  + (1|id_ternero), data=ac_dat)
m5 <- glmer(binom_ac ~ sexo  + (1|id_ternero), data=ac_dat)
compare_performance(m1,m2,m3,m4,m5)
```

```{r}
car::Anova(m1)
```

```{r}
car::Anova(m3)
```

Relacion entre madres neospora - positiva vs peso al nacer

```{r}
ac_vaca_dat <- raw %>% 
  # pivot_longer(cols = ac_0:ac_250, 
  #              names_prefix= "ac_", 
  #              names_to = "dias", 
  #              values_to = "ac")  %>% 
  # mutate_at(vars(dias), as.numeric) %>% 
  mutate_at(vars(id_ternero, trat, sexo), as.factor) %>% 
  select(id_ternero, trat, sexo, ac_vaca, peso_1, ac_0) %>% 
  mutate(binom_ac_vaca  = ifelse(ac_vaca >= 6,1,0))  
  # filter(ac<100) %>%
  # filter(dias<250) 
ac_vaca_dat
```

```{r}
ac_vaca_dat %>% 
  slice(-c(23)) %>%
  ggplot() + 
  aes(x=ac_vaca, y=peso_1,col=trat)+
  geom_point(alpha=.5) +
  geom_smooth(se=T, span=1.2)+
  facet_wrap("sexo") +
  theme_bw()
```

```{r}
m6 <- lm(peso_1 ~ ac_vaca, data=ac_vaca_dat[-c(23), ] )
m7 <- lm(peso_1 ~ trat, data=ac_vaca_dat[-c(23), ] )
m8 <- lm(peso_1 ~ sexo, data=ac_vaca_dat[-c(23), ] )
m9 <- lm(peso_1 ~ ac_vaca+sexo, data=ac_vaca_dat [-c(23), ])
m10 <- lm(peso_1 ~ ac_vaca*sexo, data=ac_vaca_dat [-c(23), ])
compare_performance(m6,m7,m8,m9, m10)

```
```{r}
car::Anova(m9)
```

```{r}
summary(m9)
```

```{r}
em <- emmeans(m9, ~ ac_vaca|sexo, type="response")
em  %>% knitr::kable()
class(em)

```

```{r}
res  <- cld(em, 
            Letters = letters, 
            alpha = .05)  
res
```

```{r}
?pwpm
pwpm(em, adjust = "none")
```

```{r}
res <- res %>% 
  mutate(letras = str_squish(.group), 
         peso_1 = emmean)
res
```

```{r}
res %>%  
  ggplot() +
  aes(x=ac_vaca, y=peso_1, col=sexo)+
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL))+
  labs(x = "IgG vaca (IRCP)", y = "Peso al nacer")+  
  geom_text(aes(label = letras), angle=90, vjust=-1)+
  geom_jitter(data = ac_vaca_dat, width = .1, alpha=.5) +
  theme_bw()
```

```

```{r}
ac_vaca_dat %>% 
  # slice(-c(23)) %>%
  ggplot() + 
  aes(x=ac_vaca, y=ac_0#,
     # col=trat
      )+
  geom_point(alpha=.5) +
  geom_smooth(se=T, span=1.2)+
  facet_wrap("sexo") +
  theme_bw()
```

```{r}
m8 <- lm(ac_0 ~ ac_vaca*sexo, data=ac_vaca_dat[-c(23), ] )
m9 <- lm(ac_0 ~ ac_vaca, data=ac_vaca_dat[-c(23), ] )
m10 <- lm(ac_0 ~ sexo, data=ac_vaca_dat[-c(23), ] )
compare_performance(m8,m9,m10)
```

```{r}
check_heteroscedasticity(m8)
```

```{r}
check_normality(m8)
```

```{r}
anova(m8)
```

Voy a realizar la prueba U de Mann-Whitney para comparar diferencias entre las madres positivas que tubieron hijos positivos a Neospora y las madres positivas que tubieron hijos seronegativos para Neospora

```{r}
library(readxl)
pacman::p_load(readxl)
library(stats)
pacman::p_load(stats)
```

```{r}
transm <- rio::import("../data/transmision verticas.xlsx")%>%
  clean_names()
transm %>% str 
transm %>% head 

```

```{r}
#base_de_datos <- read_excel("../data/transmision verticas.xlsx")
#vacas_tv <- base_de_datos %>% filter(vacas_tv == "Vacas positivas con TV")
#vacas_no_tv <- base_de_datos %>%  filter(vacas_no_tv == "Vacas positivas sin TV") +
```

```{r}
#transm <- data.frame (vacas_tv = c (72.22,49.90,80.41,62.42,65.99,73.90,103.08,97.13,74.11,106.44,54.02,55.00,41.15,62.84,48.08),
                        #vacas_no_tv = c (7.77, 7.84))

#realice la prueba U de Mann Whitney
# wilcox.test (vacas_tv ~ vacas_no_tv, data = base_de_datos)
 
```

Transmision horizontal

```{r}
transm_h <- rio::import("../data/seroconvercion.xlsx")%>%
  clean_names()
transm_h %>% str 

```

```{r}
transm_h_dat <- transm_h %>% 
  pivot_longer(cols = ac_0:ac_63, 
              names_prefix= "ac_", 
               names_to = "dias", 
                values_to = "ac")  %>% 
   mutate_at(vars(dias), as.numeric) %>% 
  mutate_at(vars(id_ternero, trat, sexo), as.factor)
  #select(id_ternero, trat, sexo,  ac_0) %>% 
  #mutate(binom_ac_vaca  = ifelse(ac_vaca >= 6,1,0))  
  # filter(ac<100) %>%
  # filter(dias<250) 
transm_h_dat
```

```{r}
transm_h_dat %>% 
  slice(-c(23)) %>%
  ggplot() + 
  aes(x=dias, y=ac, col=trat)+
  geom_point(alpha=.5) +
  geom_smooth(se=T, span=1.2)+
  geom_hline(yintercept = 6, linetype="dashed") + 
  theme_bw()
```

```{r}
reg1 <- lm(ac ~ dias, data=transm_h_dat )
reg2 <- lm(ac ~ sexo, data=transm_h_dat)
reg3 <- lm(ac ~ dias*sexo, data=transm_h_dat)
reg4 <- lm(ac ~ dias+sexo, data=transm_h_dat)
compare_performance(reg1, reg2, reg3, reg4)
 
```

```{r}
car::Anova(reg1)
```

```{r}
transm_h_dat %>% 
  slice(-c(23)) %>%
  ggplot() + 
  aes(x=dias, y=ac)+
  geom_point(alpha=.5) +
  geom_smooth(se=T, span=1.2)+
  geom_hline(yintercept = 6, linetype="dashed") + 
  theme_bw()
```

Ahora solo considerando los que seroconvirtieron

```{r}
serocon<- rio::import("../data/seroconvercion.xlsx")%>%
  clean_names()
serocon %>% str 

```

```{r}
serocon_dat <- serocon %>% 
  pivot_longer(cols = ac_0:ac_63, 
              names_prefix= "ac_", 
               names_to = "dias", 
                values_to = "ac")  %>% 
   mutate_at(vars(dias), as.numeric) %>% 
  mutate_at(vars(id_ternero, trat, sexo), as.factor)
  #select(id_ternero, trat, sexo,  ac_0) %>% 
  #mutate(binom_ac_vaca  = ifelse(ac_vaca >= 6,1,0))  
  # filter(ac<100) %>%
  # filter(dias<250) 
serocon_dat
```

```{r}
serocon_graph <- 
  # filter(dias<250) %>% 
  # filter(ac<100) %>% 
  ggplot(serocon_dat)+
  aes(x=dias, y=ac, col=id_ternero)+
  geom_jitter(width=.2, alpha=.5)+
  geom_line(stat = "summary", fun=mean)+
  # geom_line(stat = "summary", fun=median)+
  # geom_smooth(se=F, method = "lm")+
  theme_bw()+
  geom_hline(yintercept = 6, linetype="dashed") + 
  labs(y="IgG (IRCP)", x = "Días desde nacimiento")

serocon_graph
```

```{r}#
serocon_dat2 <- serocon_dat %>%  
  group_by(dias) %>% 
  summarise(
    mean = mean(ac),
    sd = sd(ac))
serocon_dat2
```
```{r}
serocon_dat <- serocon %>% 
  pivot_longer(cols = ac_0:ac_63, 
              names_prefix= "ac_", 
               names_to = "dias", 
                values_to = "ac")  %>% 
   mutate_at(vars(dias), as.factor) %>% 
  mutate_at(vars(id_ternero, trat, sexo), as.factor)
  #select(id_ternero, trat, sexo,  ac_0) %>% 
  #mutate(binom_ac_vaca  = ifelse(ac_vaca >= 6,1,0))  
  # filter(ac<100) %>%
  # filter(dias<250) 
serocon_dat

```

```{r}
reg6 <- lm(ac ~ dias, data= serocon_dat)
reg7 <- lm(ac ~ id_ternero, data = serocon_dat)
reg8 <- lm(ac ~ dias*id_ternero, data = serocon_dat)
reg9 <- lm(ac ~ dias+id_ternero, data = serocon_dat)
compare_performance(reg6, reg7, reg8, reg9)
```

```{r}
anova(reg6)
```

```{r}#
serocon_dat %>% 
  janitor::tabyl(dias)

```
```{r}
serocon_dat %>% 
  group_by(dias) %>% 
  summarise(
    n = sum(!is.na(ac)), 
    ac = mean(ac),
    sd = sd(ac))
serocon_dat
```


```{r}
dodge <- position_dodge(width = 0.5)

serocon_dat %>% 
  ggplot()  +
  aes(x = dias, y = ac) + 
  geom_point(position = dodge)

```

```{r}
geom_point(position = dodge)
```

```{r}
library(ggplot2)
library(reshape2)

```
```{r}
em <- emmeans(reg6, ~ dias, type="response")
em  %>% knitr::kable()
class(em)

```

```{r}
res  <- cld(em, 
            Letters = letters, 
            alpha = .05)  
res
```

```{r}
?pwpm
pwpm(em, adjust = "none")
```

```{r}
res <- res %>% 
  mutate(letras = str_squish(.group), 
         ac = emmean)
res
```

```{r}
res %>%  
  ggplot() +
  aes(x=dias, y=ac)+
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL))+
  labs(x = "Dias de vida", y = "IgG (IRPC)")+  
  geom_text(aes(label = letras), angle=90, vjust=-1)+
  geom_jitter(data = serocon_dat, width = .1, alpha=.5) +
  theme_bw()
```


```{r}

serocon_dat <- serocon %>% 
  pivot_longer(cols = ac_0:ac_63, 
              names_prefix= "ac_", 
               names_to = "dias", 
                values_to = "ac")  %>% 
   mutate_at(vars(dias), as.factor) %>% 
  mutate_at(vars(id_ternero, trat, sexo), as.factor)
  #select(id_ternero, trat, sexo,  ac_0) %>% 
  #mutate(binom_ac_vaca  = ifelse(ac_vaca >= 6,1,0))  
  # filter(ac<100) %>%
  # filter(dias<250) 
serocon_dat
```

```{r}
correlacion<-serocon_dat %>%  select(ac, dias)
correlacion
long_corr <- correlacion %>% 
  correlation (method = "spearman")
long_corr
```

```{r}
long_corr2 <- correlacion %>% 
  correlation (method = "pearson")
long_corr2
```

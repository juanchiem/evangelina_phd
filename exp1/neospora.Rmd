---
title: "Neospora"
output: html_document
---

```{r setup global del informe, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE, 
                      messages = FALSE)
```

```{r paquetes}
pacman::p_load(tidyverse, lubridate, janitor, ggstance)
pacman::p_load(GGally, correlation, ggcorrplot, viridis) 
pacman::p_load(cowplot, desctools)
pacman::p_load(lme4, performance, skimr, emmeans, multcomp, sjPlot, oddsratio) 
#install.packages("multcompView") # solo una vez y no hace falta cargarlo
conflicted::conflict_prefer("select", "dplyr")
conflicted::conflict_prefer("filter", "dplyr")
conflicted::conflict_prefer("chisq.test", "janitor")
conflicted::conflict_prefer("fisher.test", "janitor") 
```

Contexto: se da minerales y vitaminas asociados a propiedades antioxidantes a vacas en el periodo preparto y se evaluan diferentes variables en el ternero tales como peso vivo durante 9 semanas y luego a los 200 dias de vida aproximadamente ademas de evaluar como la ocurrencia de Neosporosis en la madre al preparto afecto el peso al nacer

## Importacion de datos

```{r}
raw <- rio::import("../exp1/data/neospora_peso.xlsx")%>%
  clean_names()
raw %>% str 
raw %>% head 
```
###Voy a evaluar si hay alguna relacion entre abortos de vacas y seropositividad
```{r}
raw1<-raw %>% 
  mutate_at(vars(abortos), as.factor)
raw1
```

```{r}
raw1 %>% 
  # filter(dias<250) %>% 
  # filter(ac<100) %>% 
  ggplot()+
  aes(x=abortos, y=ac_vaca, col=trat)+
  geom_jitter(width=.2, alpha=.5)+
   geom_line(stat = "summary", fun=mean)+
  # geom_line(stat = "summary", fun=median)+
  # geom_smooth(se=F, method = "lm")+
  theme_bw()+
  geom_hline(yintercept = 6, linetype="dashed") + 
  labs(y="Serologia", x = "Abortos")
```

```{r}
m1 <- lm (ac_vaca ~ abortos, data=raw1)
m2 <- lm (ac_vaca ~ trat, data = raw1)
m3 <- lm (ac_vaca ~ abortos*trat, data=raw1)
m4 <- lm (ac_vaca ~ abortos+trat, data=raw1)
compare_performance(m1, m2, m3, m4)
```

```{r}
car::Anova(m1)
```
```{r}
em <- emmeans(m1, ~ abortos, type="response")
em  %>% knitr::kable()
class(em)

```

```{r}
res  <- cld(em, 
            Letters = letters, 
            alpha = .05)  
res
```

```{r}
pwpm(em, adjust = "none")
```

```{r}
res <- res %>% 
  mutate(letras = str_squish(.group), 
         ac_vaca = emmean)
res
```
```{r}
res %>%  
  ggplot() +
  aes(x=abortos, y=ac_vaca)+
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL))+
  labs(x = "Number of abortions", y = "IgG prepartum cows, RICP")+  
  geom_text(aes(label = letras), angle=90, vjust=-1)+
  geom_jitter(data = raw1, width = .1, alpha=.5) +
  theme_bw()

```

```{r}
ggsave(last_plot(), file = "plots/abortos_acvaca.png", w=8, h=8)

```
```{r}
res %>%  
  ggplot() +
  aes(x=abortos, y=ac_vaca)+
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL))+
  labs(x = "Number of abortions", y = "IgG prepartum cows, RICP")+   stat_summary(fun= mean,  #median
               fun.min= mean,
               fun.max = mean,
               geom = "point", 
               size = 2)+
    geom_text(aes(label = letras), angle=90, vjust=-1)+
 # geom_jitter(data = raw1, width = .1, alpha=.5) +
  theme_bw()

```
```{r}
res %>%  
  ggplot() +
  aes(x=abortos, y=ac_vaca)+
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL))+
  labs(x = "Number of abortions", y = "IgG prepartum cows, RICP")+  
  geom_text(aes(label = letras), angle=90, vjust=-1)+
  geom_jitter(data = raw1, width = .1, alpha=.5) +
    stat_summary(fun = mean,  #median
               fun.min= mean,
               fun.max = mean,
               geom = "crossbar", 
               size = 0.5)+
  
  theme_bw()
  

```
```{r}
res %>%  
  ggplot() +
  aes(x=abortos, y=ac_vaca)+
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL))+
  labs(x = "Number of abortions", y = "IgG prepartum cows, RICP")+  
  geom_text(aes(label = letras), angle=0, vjust=-2, hjust= -1)+
  geom_jitter(data = raw1, width = .1, alpha=.5) +
    stat_summary(fun = mean,  #median
               fun.min= mean,
               fun.max = mean,
               geom = "crossbar", 
               size = 0.5)+
     geom_hline(yintercept = 6, linetype="dashed") + 
  
    theme_bw()

```
```{r}
ggsave(last_plot(), file = "plots/abortos_IgGvaca.png", w=8, h=8)
```
### Paso las variables abortos y ac_vacas a binomial para poder hacer luego el chi cuadrado
```{r}
abort_dat <- raw %>% 
  select(ac_vaca, abortos) %>% 
  mutate(binom_ac  = ifelse(ac_vaca >= 6,"+","-")) %>% 
  mutate(binom_abort = ifelse(abortos>=1, 1,0)) 

abort_dat %>% str

```
```{r}
abort<-abort_dat %>% 
  select(binom_ac, binom_abort)
abort
```
```{r}
tabla <- xtabs (~ binom_ac + binom_abort, data = abort)
tabla
```
```{r}
ftable(tabla)
```
```{r}
chisq.test(tabla)
```
```{r}
fisher.test(tabla)
```

```{r}
summary(tabla)
```
Se realizo la prueba de chi cuadrado para examinar la asociacion entre serologia y abortos y se encontro una asociacion significativa entre las variables x2 (gl1), x = 6.862, p<0.01. Al calcular el odd ratio se encontro que las vacas seropositivas tienen 4.85 veces mas provabilidades de abortar en comparacion con las vacas seronegativas

## Voy a ver si el nivel de Acs de las madres se vio afectado por el tratamiento

```{r}
m1 <- lm (ac_vaca ~ trat, data=raw1)
```
```{r}
anova(m1)
```
## Voy a ver si el tratamiento afecto el nivel de Acs de los terneros al nacer
```{r}
m1 <- lm(ac_0~trat, data=raw1)
m2 <- lm(ac_0~sexo, data=raw1)
m3 <- lm(ac_0~trat*sexo, data=raw1)
m4 <- lm(ac_0~trat+sexo, data=raw1)
compare_performance(m1,m2,m3,m4)
```
```{r}
anova(m2)
```
Tanto el nivel de anticuerpos de la madre como del ternero al nacer no se vieron afectados por el tratamiento con antioxidantes pero hubo una tendencia a que el sexo del ternero afectara el nievl de acs al nacer

####Acomodo la tabla (la pivoteo)
```{r}
ac_dat <- raw %>% 
  pivot_longer(cols = ac_0:ac_250, 
               names_prefix= "ac_", 
               names_to = "dias", 
               values_to = "ac")  %>% 
  mutate_at(vars(dias), as.numeric) %>% 
  mutate_at(vars(id_ternero, trat, sexo), as.factor) %>% 
  select(id_ternero, trat, sexo, dias, ac) %>% 
  mutate(binom_ac  = ifelse(ac >= 6,1,0)) %>% 
  # filter(ac<100) %>% 
  filter(dias<250) 

ac_dat %>% str

ac_dat %>% 
  group_by(sexo, trat) %>%  
  skim(ac)
```
### Grafico exploratorio para ver la evolucion de anticuerpos a lo largo del periodo experimental segun tratamiento y sexo
```{r}
ac_dat %>% 
  ggplot()+
  aes(x=dias, y=ac, col=trat)+
  geom_jitter(width=.2, alpha=.5)+
  facet_wrap("sexo") + 
  geom_line(stat = "summary", fun=mean)+
  # geom_line(stat = "summary", fun=median)+
  # geom_smooth(se=F, method = "lm")+
  theme_bw()+
  geom_hline(yintercept = 6, linetype="dashed") + 
  labs(y="IgG (IRCP)", x = "Días desde nacimiento")
```

```{r}
ac_dat %>% 
  ggplot()+
  aes(x=dias, y=binom_ac, col=trat)+
  geom_point(alpha=.5)+
  facet_wrap("sexo") + 
  geom_smooth(method = "glm", 
              # se=F, 
              method.args = list(family = "binomial"), 
              linetype = "dashed")+
  theme_bw()+
  labs(y="IgG (IRCP)", x = "Días desde nacimiento")
```

Ajustaremos un modelo mixto que contemple las medidas repetidas en el tiempo sobre una misma unidad experimental, para ello le asignamos el efecto aleatorio a la misma.

```{r}
m1 <- glmer(binom_ac ~ dias * trat * sexo + (1|id_ternero), data=ac_dat)
m2 <- glmer(binom_ac ~ dias + trat + sexo + (1|id_ternero), data=ac_dat)
m3 <- glmer(binom_ac ~ dias  + (1|id_ternero), data=ac_dat)
m4 <- glmer(binom_ac ~ trat  + (1|id_ternero), data=ac_dat)
m5 <- glmer(binom_ac ~ sexo  + (1|id_ternero), data=ac_dat)
compare_performance(m1,m2,m3,m4,m5)
```

```{r}
car::Anova(m1)
```

```{r}
car::Anova(m3)
```
### Relacion entre Acs madres POSITIVAS Y NEGATIVAS y peso al nacer

```{r}

ac_cow <- raw %>% 
  select(id_ternero, trat, sexo, ac_vaca, peso_1, ac_0) %>% 
  mutate(binom_ac = ifelse(ac_vaca >=6,1,0)) 
ac_cow
```

```{r}
ac_cow1 <- ac_cow %>% 
  mutate_at(vars(id_ternero, trat, sexo), as.factor) %>% 
  select(id_ternero, trat, sexo, binom_ac, peso_1, ac_0) 
ac_cow1
```

```{r}
ac_cow1 %>% 
  slice(-c(23)) %>%
  ggplot() + 
  aes(x=binom_ac, y=peso_1, col=trat)+
  geom_point(alpha=.5) +
 # geom_smooth(se=T, span=1.2)+
  facet_wrap("sexo") +
  theme_bw()
```
```{r}
m6 <- lm(peso_1 ~ binom_ac, data=ac_cow1[-c(23), ] )
m7 <- lm(peso_1 ~ trat, data=ac_cow1[-c(23), ] )
m8 <- lm(peso_1 ~ sexo, data=ac_cow1[-c(23), ] )
m9 <- lm(peso_1 ~ binom_ac+sexo+trat, data=ac_cow1 [-c(23), ])
m10 <- lm(peso_1 ~ binom_ac*sexo*trat, data=ac_cow1 [-c(23), ])

compare_performance(m6,m7,m8,m9, m10)

```
```{r}
car::Anova(m10)
```

Al explorar el efecto de la presencia o ausencia de infeccion por N. caninum en las madres sobre el peso al nacer de los terneros, solo se ve efeco del sexo de los terneros, pero no hay efecto del tratamiento ni de los anticuerpos de las madres. 

###Relacion entre madres neospora POSITIVAS vs peso al nacer
```{r}
ac_vaca_dat <- raw %>% 
  mutate_at(vars(id_ternero, trat, sexo), as.factor) %>% 
  select(id_ternero, trat, sexo, ac_vaca, peso_1, ac_0) %>% 
  filter(ac_vaca>=6)
 ac_vaca_dat
```

```{r}
ac_vaca_dat %>% 
  slice(-c(23)) %>%
  ggplot() + 
  aes(x=ac_vaca, y=peso_1)+
  geom_point(alpha=.5) +
  geom_smooth(se=T, span=1.2)+
  facet_wrap("sexo") +
  theme_bw()
```

```{r}
m6 <- lm(peso_1 ~ ac_vaca, data=ac_vaca_dat[-c(23), ] )
m7 <- lm(peso_1 ~ trat, data=ac_vaca_dat[-c(23), ] )
m8 <- lm(peso_1 ~ sexo, data=ac_vaca_dat[-c(23), ] )
m9 <- lm(peso_1 ~ ac_vaca+sexo+trat, data=ac_vaca_dat [-c(23), ])
m10 <- lm(peso_1 ~ ac_vaca*sexo*trat, data=ac_vaca_dat [-c(23), ])
compare_performance(m6,m7,m8,m9, m10)


```
```{r}
car::Anova(m10)
```

```{r}
summary(m10)

```

```{r}
em <- emmeans(m10, ~ ac_vaca|sexo|trat, type="response")
em  %>% knitr::kable()
class(em)

```

```{r}
res  <- cld(em, 
            Letters = letters, 
            alpha = .05)  
res
```

```{r}
pwpm(em, adjust = "none")
```

```{r}
res <- res %>% 
  mutate(letras = str_squish(.group), 
         peso_1 = emmean)
res
```


## Voy a evaluar como afecta el nivel de acs de la madre al nivel de acs del hijo/a al nacer
```{r}
ac_vaca_dat %>% 
  # slice(-c(23)) %>%
  ggplot() + 
  aes(x=ac_vaca, y=ac_0#,
     # col=trat
      )+
  geom_point(alpha=.5) +
  geom_smooth(se=T, span=1.2)+
  facet_wrap("sexo") +
  geom_hline(yintercept = 6, linetype="dashed") + 
  theme_bw()
```

```{r}
m8 <- lm(ac_0 ~ ac_vaca*sexo*trat, data=ac_vaca_dat[-c(23), ] )
m9 <- lm(ac_0 ~ ac_vaca, data=ac_vaca_dat[-c(23), ] )
m10 <- lm(ac_0 ~ sexo, data=ac_vaca_dat[-c(23), ] )
m11 <- lm(ac_0 ~ ac_vaca+sexo+trat, data=ac_vaca_dat[-c(23), ] )
m12 <- lm(ac_0 ~ trat, data=ac_vaca_dat[-c(23), ] )
compare_performance(m8,m9,m10,m11,m12)
```

```{r}
check_heteroscedasticity(m8)
```

```{r}
check_normality(m8)
```

```{r}
anova(m11)
```

```{r}
em <- emmeans(m11, ~ ac_vaca|trat, type="response")
em  %>% knitr::kable()
class(em)
```

```{r}
res  <- cld(em, 
            Letters = letters, 
            alpha = .05)  
res
```

```{r}
pwpm(em, adjust = "none")
```

```{r}
res <- res %>% 
  mutate(letras = str_squish(.group), 
         ac_0 = emmean)
res
```
No hubo efecto del tratamiento sobre el nivel de acs pero si se vio afectado por el nivel de acs de la madre

Voy a realizar la prueba U de Mann-Whitney para comparar diferencias entre las madres positivas que tubieron hijos positivos a Neospora y las madres positivas que tubieron hijos seronegativos para Neospora

```{r}
library(readxl)
pacman::p_load(readxl)
library(stats)
pacman::p_load(stats)
```

```{r}
transm <- rio::import("../data/transmision verticas.xlsx")%>%
  clean_names()
transm
  
```
```{r}
tv <- c(72.21833, 49.89503,80.40588, 80.40588, 62.42127, 65.99020, 73.89783, 103.07908, 97.13086, 74.10777, 106.43807)
ntv <- c(7.77, 7.84)
grupo <- c(rep("transmision_vertical", length(tv)), rep("no_transmision_vertical", length(ntv)))
estudio <- data.frame(acs=c(tv, ntv), grupo)
estudio

```
```{r}
wilcox.test(acs ~ grupo, data=estudio)
```
#Transmision horizontal

En este analisis considero todos los terneros, aquellos que nacieron infectados y los que no.. por eso creo que esta mal, si nacieron infectados ya no hay TH
```{r}
transm_h <- raw %>% 
  pivot_longer(cols = ac_0:ac_63, 
              names_prefix= "ac_", 
               names_to = "dias", 
                values_to = "ac")  %>% 
   mutate_at(vars(dias), as.numeric) %>% 
  mutate_at(vars(id_ternero, trat, sexo), as.factor)
  transm_h
```

```{r}
transm_h %>% 
  slice(-c(23)) %>%
  ggplot() + 
  aes(x=dias, y=ac, col=trat)+
  geom_point(alpha=.5) +
  geom_smooth(se=T, span=1.2)+
  geom_hline(yintercept = 6, linetype="dashed") +
  facet_wrap("sexo")
  theme_bw()
```

```{r}
reg1 <- lm(ac ~ dias, data=transm_h )
reg2 <- lm(ac ~ sexo, data=transm_h)
reg3 <- lm(ac ~ dias*sexo*trat, data=transm_h)
reg4 <- lm(ac ~ dias+sexo+trat, data=transm_h)
reg5 <- lm(ac ~ trat, dat=transm_h)
compare_performance(reg1, reg2, reg3, reg4, reg5)
 
```

```{r}
car::Anova(reg3)
```

```{r}
transm_h %>% 
  slice(-c(23)) %>%
  ggplot() + 
  aes(x=dias, y=ac, col=trat)+
  facet_wrap("sexo")+
  geom_point(alpha=.5) +
  geom_smooth(se=T, span=1.2)+
  geom_hline(yintercept = 6, linetype="dashed") + 
  theme_bw()
```
```{r}
em <- emmeans(reg3, ~ sexo, type="response")
em  %>% knitr::kable()
class(em)

```

```{r}
res  <- cld(em, 
            Letters = letters, 
            alpha = .05)  
res
```

```{r}
pwpm(em, adjust = "none")
```

```{r}
res <- res %>% 
  mutate(letras = str_squish(.group), 
         acs = emmean)
res
```

###Ahora solo considerando los que seroconvirtieron

```{r}
serocon<- rio::import("../data/seroconvercion.xlsx")%>%
  clean_names()
serocon %>% str 

```

```{r}
serocon_dat <- serocon %>% 
  pivot_longer(cols = ac_0:ac_63, 
              names_prefix= "ac_", 
               names_to = "dias", 
                values_to = "ac")  %>% 
   mutate_at(vars(dias), as.numeric) %>% 
  mutate_at(vars(id_ternero, trat, sexo), as.factor)
  serocon_dat
```

```{r}
serocon_graph <- 
  # filter(dias<250) %>% 
  # filter(ac<100) %>% 
  ggplot(serocon_dat)+
  aes(x=dias, y=ac, col=id_ternero)+
  geom_jitter(width=.2, alpha=.5)+
  geom_line(stat = "summary", fun=mean)+
  # geom_line(stat = "summary", fun=median)+
  # geom_smooth(se=F, method = "lm")+
  facet_wrap("trat")+
  theme_bw()+
  geom_hline(yintercept = 6, linetype="dashed") + 
  labs(y="IgG (IRCP)", x = "Días desde nacimiento")
 
serocon_graph
```
Como vemos todos los terneros que seroconvirtieron pertenecian al grupo control, aunque el n para sacar conclusiones es muy bajo

```{r}
serocon_dat <- serocon %>% 
  pivot_longer(cols = ac_0:ac_63, 
              names_prefix= "ac_", 
               names_to = "dias", 
                values_to = "ac")  %>% 
   mutate_at(vars(dias), as.factor) %>% 
  mutate_at(vars(id_ternero, trat, sexo), as.factor)
  #select(id_ternero, trat, sexo,  ac_0) %>% 
  #mutate(binom_ac_vaca  = ifelse(ac_vaca >= 6,1,0))  
  # filter(ac<100) %>%
  # filter(dias<250) 
serocon_dat

```

```{r}
reg6 <- lm(ac ~ dias, data= serocon_dat)
reg7 <- lm(ac ~ id_ternero, data = serocon_dat)
reg8 <- lm(ac ~ dias*id_ternero, data = serocon_dat)
reg9 <- lm(ac ~ dias+id_ternero, data = serocon_dat)
compare_performance(reg6, reg7, reg8, reg9)
```

```{r}
anova(reg6)
```
```{r}
serocon_dat %>% 
  group_by(dias) %>% 
  summarise(
    n = sum(!is.na(ac)), 
    ac = mean(ac),
    sd = sd(ac))
serocon_dat
```


```{r}
serocon_dat %>% 
  ggplot()  +
  aes(x = dias, y = ac) + 
  geom_point(position = dodge)

```

```{r}
library(ggplot2)
library(reshape2)

```
```{r}
em <- emmeans(reg6, ~ dias, type="response")
em  %>% knitr::kable()
class(em)

```

```{r}
res  <- cld(em, 
            Letters = letters, 
            alpha = .05)  
res
```

```{r}
pwpm(em, adjust = "none")
```

```{r}
res <- res %>% 
  mutate(letras = str_squish(.group), 
         ac = emmean)
res
```

```{r}
res %>%  
  ggplot() +
  aes(x=dias, y=ac)+
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL))+
  labs(x = "Dias de vida", y = "IgG (IRPC)")+  
  geom_text(aes(label = letras), angle=90, vjust=-1)+
  geom_jitter(data = serocon_dat, width = .1, alpha=.5) +
 
  theme_bw()

```
```{r}

antipeso <- raw %>% 
  pivot_longer(cols = ac_0:ac_63, 
              names_prefix= "ac_", 
               names_to = "dias", 
                values_to = "ac")  %>% 
  mutate_at(vars(dias), as.factor) %>% 
  mutate_at(vars(id_ternero, trat, sexo), as.factor) %>% 
  select(id_ternero, trat, sexo,  ac, peso_1, peso_7, peso_14, peso_21, peso_28, peso_35, peso_42, peso_49, peso_56, peso_63 )
  #mutate(binom_ac_vaca  = ifelse(ac_vaca >= 6,1,0))  
  # filter(ac<100) %>%
  # filter(dias<250) 
antipeso
```
```{r}
ac_peso <- antipeso %>% 
  pivot_longer(cols = peso_1:peso_63, 
               names_prefix= "peso_", 
               names_to = "dias", 
               values_to = "peso") %>% 
     mutate_at(vars(dias), as.numeric) %>% 
  mutate_at(vars(id_ternero, trat, sexo), as.factor) %>% 
  select(id_ternero, trat, sexo, dias, ac, peso)

ac_peso 

ac_peso %>% 
  group_by(sexo, trat) %>%  
  skim(ac)
```
```{r}
m1 <- lm(peso~ac, data = ac_peso)
m2 <- lm(peso~trat, data = ac_peso)
m3 <- lm(peso~sexo, data = ac_peso)
m4 <- lm(peso~dias, data = ac_peso)
m5 <- lm(peso~ac*trat*sexo*dias, data = ac_peso)
m6 <- lm(peso~ac+sexo+trat+dias, data = ac_peso)
compare_performance(m1,m2,m3,m4,m5,m6)
```

```{r}
anova(m5)
```
```{r}
em <- emmeans(m5, ~ trat, type="response")
em  %>% knitr::kable()
class(em)

```

```{r}
res  <- cld(em, 
            Letters = letters, 
            alpha = .05)  
res
```

```{r}
pwpm(em, adjust = "none")
```

```{r}
res <- res %>% 
  mutate(letras = str_squish(.group), 
         peso = emmean)
res
```
```{r}
acColor <- "#69b3a2" #Color para Acs
pesoColor <- "#CD6155" # Color para peso
acpeso_graph<-data.frame(cbind(ac_peso, acColor,pesoColor))
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL))+
  geom_text(aes(label = letras), angle=90, vjust=-1)+
  geom_jitter(data = serocon_dat, width = .1, alpha=.5) +
ggplot(acpeso_graph, aes(x=dias))+
  geom_point(aes(y=peso), size=1, color=pesoColor)+ 
  geom_point(aes(y=ac), size=1, color=acColor)+
  geom_jitter(width=.2, alpha=.5)+
  geom_line(stat = "summary", fun=mean)+
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL))+
  geom_text(aes(label = letras), angle=90, vjust=-1)+
  geom_jitter(data = serocon_dat, width = .1, alpha=.5) +
 
  theme_bw()+

  scale_y_continuous(name="IgG, RICP",
               sec.axis = sec_axis(~.*1,name = "Body weight, Kg"))+
    theme(
    axis.title.y = element_text(color=pesoColor, size=13),
    axis.title.y.right = element_text(color=acColor, size = 13)
  )+
    facet_wrap("trat")+
  theme_bw()+
  geom_hline(yintercept = 6, linetype="dashed") + 

  xlab("Days from birth")

```





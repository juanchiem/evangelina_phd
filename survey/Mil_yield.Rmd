---
title: "Milk Yield"
author: "Evangelina"
date: "2023-07-18"
output: html_document
---

```{r setup global del informe, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      messages = FALSE)
```
```{r data}
dat <- rio::import(here::here("survey/survey23.csv"))
```

```{r paquetes}
pacman::p_load(tidyverse, janitor,  skimr, 
               # GGally, correlation, 
               # performance, 
               scales, 
               # emmeans, multcomp, finalfit,  
               # oddsratio,
               coefplot, 
               OddsPlotty, 
               relaimpo, 
               gtools, 
               sjPlot)
pacman::p_load(rpart, rpart.plot)
conflicted::conflict_prefer("select", "dplyr")
conflicted::conflict_prefer("filter", "dplyr")
```

# Milk yield

```{r}
dat_milk <- dat %>% 
  select(-c(mortality, scc, afb, ffi)) %>% 
  drop_na()
dat_milk %>% skim()
```

## Reg lineal multiple

```{r}
mod <- lm(milk_yield ~ ., data= dat_milk)
summary(mod)
mod_step <- stepAIC(mod,  direction="both")
summary(mod_step)
```

```{r}
coefplot(mod_step, intercept = FALSE)
```
En este grafico podemos ver todas las variables que tienen efecto sobre milk_yield aumentan (segun el modelo solo la alimentacion de las vacas y el volumen de calostro tienen efecto).

* Importancia relativa

Analizo la importancia relativa de las variables presentes en el modelo

```{r}
ri <- calc.relimp(mod_step, type="car", rela=TRUE)
ri
```
Se puede ver que el tipo de alimentacion de las vacas tiene una importacia del 37% sobre produccion de leche, y el volumen de calostro del 33%.

```{r}
dat2 <- dat_milk %>%
    mutate( Milk_yield_band = quantcut(milk_yield, q = c(0, 0.33, 0.66, 1), 
            labels = c("Low", "Mid", "High")))

table(dat2$milk_yield, dat2$Milk_yield_band)
```
## Reg log - Milk_yield. Tansformo la variable mortalidad a trinaria?

```{r}
library(gtools)
```

```{r}
mod_bin <-glm(Milk_yield_band ~ liquid_feeding_volume+experience+hygiene+capacitations+realiza_calostrado + feed_cows, clostrum_feeding_vol, data = dat2, family = binomial)
mod_step <- stepAIC(mod_bin,  direction="both")
summary(mod_step)
```

```{r}
tab_model(mod_step)
odds_plot(mod_step)
```
```{r}
ggsave(last_plot(), file="survey/odds_my.tiff", 
       w=80, h=60, units="mm", dpi=300)
```
```{r}
df<-data.frame (boxLabels = c( "Experience", "Hygiene", "Method of colostrum feeding", "Type of feed cows"),
boxOdds =  c(1.87, 1.70, 2.16, 5.78),
boxCILow = c(1.39, 1.13, 1.34, 2.35),
boxCIHigh = c(2.56, 2.59, 3.59, 16.68))
df
```



```{r}
(p <- ggplot(df, aes(x = boxOdds, y = boxLabels)) + 
    geom_vline(aes(xintercept = 1), size = .2, linetype = "dashed") + 
    geom_errorbarh(aes(xmax = boxCIHigh, xmin = boxCILow), size = .2, height = 
                    .1, color = "gray50") +
    geom_point(size = 1.5, color = "orange") +
   # coord_trans(x = scales:::exp_trans(10)) +
   # scale_x_continuous(breaks = log10(seq(0.5, 17.0, 0.5)), labels = seq(0.5, 17.0, 0.5),
       #                limits = log10(c(0.5,17.0))) +
    theme_bw()+
    theme(panel.grid.minor = element_blank()) +
    ylab("") +
    xlab("Odds ratio")  
) 
```

```{r}
ggsave(last_plot(), file="survey/odds_MY_end.tiff", 
       w=150, h=100, units="mm", dpi=300)
```

## Random forest

```{r}
dat2 %>% names
# set the target variable
targ <- "milk_yield_band"
# set the predictors
preds <- c(
 "experience", "realiza_calostrado",
"hygiene", "feed_cows")


# build a simple rpart decision tree using the default settings
dtree <- rpart(formula = dat2[,targ] ~ ., data = dat2[,preds])
```

## Arbol de clasificacion

```{r}
rpart.plot(dtree)
# dtree
```
En este arbol de prediccion se ve que si e metodo de calostrado era al pie de la madre, la produccion de leche era baja en un 34% de los casos y si a su vez se suministraba un volumen de calostro menor a 4 litros antes de las 24 horas de nacido la prod. era baja en 21 % de los establecimientos encuestads. Por otro lado si el calostro era dado de forma arificial, y se suministraba un volumen antes de las 24 hs superior a 4, la produccion de leche era alta


```{r}
ggsave(last_plot(), file="survey/tree_milk.tiff", 
       w=150, h=100, units="mm", dpi=300)
```

* Histograma de importancia de las variables predictoras sobre mortalidad


```{r}
data.frame(Importance = dtree$variable.importance) %>% 
  rownames_to_column("Variable") %>% 
 
  arrange(Importance) %>%
  mutate(variable = fct_inorder(Variable)) %>% 
ggplot() +
 aes(x = Variable, y = Importance)+
           geom_col(width = 0.03) +
  geom_point() +
  coord_flip()
```

```{r}
ggsave(last_plot(), file="survey/importance_milk.tiff", 
       w=150, h=100, units="mm", dpi=300)
```
## Factorizo variables predictoras
Si factorizo las variables predictoras, el modelo queda de la siguiente forma:


```{r}
dat_milk2 <- dat %>% 
  select(-c(mortality, scc, afb, ffi, vacination)) %>%
  mutate_at(vars(-(milk_yield)),as.factor) %>%
  drop_na()  
  # str
dat_milk2
```
## Reg. lineal múltiple

```{r}
mod <- lm(milk_yield ~ ., data= dat_milk2)
anova(mod)

mod_step <- stepAIC(mod,  direction="both")
anova(mod_step)
```
Se puede ver que en el modelo las variables preparto, metodo de calostrado, volumen de calostro y alimentacion de las vacas impactan en la produccion de leche, mientras que disease ranking si bien no afecta la produccion de leche igual es incluida en el modelo.

```{r}
coefplot(mod_step, intercept = FALSE)
```
Este grafico muestra que el tipo de alimentacion TMR es el que impacta en la produccion de leche

## Reg log - milk_yield_band. 


```{r}
mod_bin <-glm(milk_yield_band ~ prepartum+ liquid_feeding_volume+experience+hygiene+capacitations+realiza_calostrado + feed_cows, clostrum_feeding_vol, data = dat2, family = binomial)
mod_step <- stepAIC(mod_bin,  direction="both")
car::Anova(mod_step)
summary(mod_step)
```
```{r}
tab_model(mod_step)
```
Cuando corremos  el modelo con milk_yield trinaria? y las otras variables como factor, vemos que experiencia higyene, metodo de calostrado y alimentacion de las vacas impactan en la produccion de leche 
```{r}
odds_plot(mod_step)
```

## Árbol de clasificación

<!-- https://www.displayr.com/how-is-variable-importance-calculated-for-a-random-forest/#:~:text=This%20importance%20is%20a%20measure,accuracy%20due%20to%20random%20noise. -->


```{r}
dtree_quant <- rpart(milk_yield ~ experience + hygiene + realiza_calostrado + 
    feed_cows, data = dat2)
dtree_quant
summary(dtree_quant)
rpart.plot(dtree_quant)
```

Clasifica los casos. 
- las particiones que aparecen arriba son las que capturan mayor variabilidad
- vas particionando en grupos menores, mas chicos, con menos variablidad
- irian en linea con variable importance
La media de produccion de leche de todas las encuestas es de 7693 litros. Si la alimentacion es TMR (>3), 28% de los establecimientos llegan a 8581 litros y si el personal tiene experiencia en preparto, se llega a 8968 litros.

- Importancia de las variables predictoras sobre mortalidad

```{r}
data.frame(imp = dtree_quant$variable.importance) %>%
  rownames_to_column("variable") %>% 
  # distinct(variable)
  arrange(imp) %>%
  mutate(variable = fct_inorder(variable)) %>%
  ggplot() +
  aes(x = variable, y = imp) +
  geom_col(width = 0.03) +
  geom_point() +
  coord_flip()
```
## Random forest 

<!-- https://rubenfcasal.github.io/aprendizaje_estadistico/cart-con-el-paquete-rpart.html -->

```{r}
tree_milk <- rpart(milk_yield ~ ., data = dat2)
rpart.plot(tree_milk)  
```

```{r}
rpart.rules(tree_milk, style = "tall")
```

```{r}
importance <- tree_milk$variable.importance # Equivalente a caret::varImp(tree) 
importance <- round(100*importance/sum(importance), 1)
importance
```

```{r}
data.frame(importance = tree_milk$variable.importance) %>%
  rownames_to_column("variable") %>% 
  # distinct(variable)
  arrange(importance) %>%
  mutate(variable = fct_inorder(variable)) %>%
  ggplot() +
  aes(x = variable, y = importance) +
  geom_col(width = 0.03) +
  geom_point() +
  coord_flip()
```


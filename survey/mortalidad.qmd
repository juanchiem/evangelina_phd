```{r data}
dat <- rio::import(here::here("survey/survey23.csv"))
```

```{r paquetes}
pacman::p_load(tidyverse, janitor,  skimr, 
               # GGally, correlation, 
               performance, 
               scales, 
               # emmeans, multcomp, finalfit,  
               # oddsratio,
               coefplot, 
               OddsPlotty, 
               relaimpo, 
               gtools, 
               SjPlot)
pacman::p_load(rpart, rpart.plot)
conflicted::conflict_prefer("select", "dplyr")
conflicted::conflict_prefer("filter", "dplyr")
```


## Mortalidad

```{r}
dat_mort <- dat %>% 
  select(-c(feed_cows, milk_yield, scc, afb, ffi)) %>% 
  drop_na()
dat_mort %>% skim()
```

### Reg log - mort<5

```{r}
mod_bin <- glm(mortality > 5 ~ ., data=dat_mort)
mod_step <- stepAIC(mod_bin,  direction="both")
summary(mod_step)
odds_plot(mod_step)
```

Podemos ver en la tabla que se reduce en un 80% (1-0.2) la probabilidad de que la mortalidad sea mayor al 5% cuando el volumen de dieta liquida pasa de 2 a 4 litros y de 4 a 6 litros. (Por cada salto, la probabilidad re reduce un 80%).

### Regresion lineal multiple

```{r}
mod <- lm(mortality ~ ., data= dat_mort)
summary(mod)
mod_step <- stepAIC(mod,  direction="both")
summary(mod_step)
```

```{r}
coefplot(mod_step, intercept = FALSE)
```

En este grafico podemos ver todas las variables que tienen efecto sobre mortalidad la disminuyen, menos vacunacion la cual muestra que al aumentar la vacunacion aumenta la mortalidad. Preguntar a Lu como armo la tabla..

Analizo la importancia relativa de las variables presentes en el modelo

```{r}
ri <- calc.relimp(mod_step, type="car", rela=TRUE, rank = TRUE) 
ri
```

El volumen de dieta liquida explica el 30% de la mortalidad, seguido de capacitaciones con 21% e higiene con 18%

```{r}
# dat %>% 
#   select(mortality, vacination, experience, capacitations, liquid_feeding_volume, hygiene) %>% 
#   ggpairs()

dat %>% 
  ggplot() + 
  aes(vacination, mortality) + 
  geom_jitter(width = .1) + 
  geom_smooth()
```

Este ultimo grafico exploratorio muestra que en realidad hay pocos datos para el nivel de vacunacion 1 y a lo mejor ahi esta la explicacion del porque da raro el resultado (>vacunacion>mortalidad)

### Arbol de clasificacion

```{r}
# https://www.displayr.com/how-is-variable-importance-calculated-for-a-random-forest/#:~:text=This%20importance%20is%20a%20measure,accuracy%20due%20to%20random%20noise.
```

```{r}
dat_mort$mortality %>% hist
```

```{r}
dtree_quant <- rpart(
  mortality ~ liquid_feeding_volume+hygiene+capacitations+experience, 
  data = dat_mort)
dtree_quant
summary(dtree_quant)
rpart.plot(dtree_quant)
```

Clasifica los casos. Ayuda a explicar como se relacionan las variables con la mortalidad. Asi, de las encuestas con baja mortalidad un 42% daba alto vol de dieta liquida (>=3 - preguntar a Lu como hizo la clasificacion para interpretar mejor), de ese 42% un 92% tubo baja mortalidad. De los que dieron menor volumen de dieta iquida, cuando realizaron practicas de higiene y capacitacion tuvieron baja mortalidad (25%) y media mortalidad el 19%. Mientras que el 14% restante que alimento con poco volumen y no hizo nada mas (higiene ni capacitacion) tuvo alta mortalidad.

- Importancia de las variables predictoras sobre mortalidad

```{r}
df <- data.frame(imp = dtree_quant$variable.importance) %>% 
  rownames_to_column() %>% 
  rename("variable" = rowname) %>% 
  arrange(imp) %>%
  mutate(variable = fct_inorder(variable))
# Basic piechart

df %>% 
  ggplot() +
  geom_col(aes(x = variable, y = imp),
           col = "black", show.legend = F) +
  coord_flip() +
  scale_fill_grey() +
  theme_bw()
```





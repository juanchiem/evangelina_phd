---
title: "Mortalidad"
format: html
editor: source
editor_options: 
  chunk_output_type: console
---

```{r setup global del informe, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      messages = FALSE
                      )
```

```{r data}
# dat <- rio::import(here::here("survey/survey23.csv"))
dat <- read.csv("https://raw.githubusercontent.com/juanchiem/agro_data/master/survey23.csv", sep = ",") 
```

```{r paquetes, include=FALSE}
pacman::p_load(tidyverse, janitor,  skimr, 
               # GGally, correlation, 
               # performance, 
               scales, 
               # emmeans, multcomp, 
               # oddsratio,
               coefplot, 
               OddsPlotty, 
               relaimpo, 
               gtools, 
               sjPlot,
               finalfit)
pacman::p_load(rpart, rpart.plot)
conflicted::conflict_prefer("select", "dplyr")
conflicted::conflict_prefer("filter", "dplyr")
```

##  Datos

```{r}
dat_mort <- dat %>% 
  select(-c(feed_cows, milk_yield, scc, afb, ffi, vacination)) %>%
  mutate_at(vars(-(mortality)),as.factor) %>%
  drop_na()  
  # str
dat_mort %>% skim()
hist(dat_mort$mortality) 
```
En ese histograma podemos ver la frecuencia de distribucion de mortalidad en los establecimientos encuestados. Se puede ver que el 40% de los encuestados tiene < del 5% de mortalidad, seguido de un 30% con mortalidad entre 5 y 10%.

## Reg. lineal múltiple

```{r}
mod <- lm(mortality ~ ., data= dat_mort)
anova(mod)

mod_step <- stepAIC(mod,  direction="both")
anova(mod_step)
```

```{r}
coefplot(mod_step, intercept = FALSE)
```

En este grafico podemos ver todas las variables que tienen efecto sobre mortalidad la disminuyen, menos vacunacion la cual muestra que al aumentar la vacunacion aumenta la mortalidad y sistema de crianza que representa el alojamiento de los animales. Preguntar a Lu como armo la tabla..

Analizo la importancia relativa de las variables presentes en el modelo

```{r}
ri <- calc.relimp(mod, type="car", rela=TRUE, rank = TRUE)
```

La experiencia representa un 42% de la variacion en mortalidad, capacitaciones el 15% y vol de dieta liquida 14%

```{r}
dat %>% 
  ggplot() + 
  aes(vacination, mortality) + 
  geom_jitter(width = .1) + 
  geom_smooth()
```

Este ultimo grafico exploratorio muestra que en realidad hay pocos datos para el nivel de vacunacion 1 y a lo mejor ahi esta la explicacion del porque da raro el resultado (>vacunacion>mortalidad)


## Reg log - mort<3. Tansformo la variable mortalidad a binaria (> o < a 3)

```{r}
<<<<<<< HEAD
mod_bin <- glm(mortality > 3 ~ ., data=dat_mort)
=======
mod_bin <- glm(mortality >= 3 ~ ., data=dat_mort)
car::Anova(mod_bin)

>>>>>>> 90fe7143d9f46f7d506657c2dee969fe14ff9029
mod_step <- stepAIC(mod_bin,  direction="both")
car::Anova(mod_step)

summary(mod_step)
tab_model(mod_step)
```

Cuando corremos  el modelo con mortalidad como binaria, sale del modelo el sistema de alojamiento e ingresa la variable volumen de calostro consumido antes de las 24 hs. Esta variable si bien no tiene efecto, si es importante para el modelo y por eso la ingresa, higiene en este caso pierde su nivel de significancia pero permanece en el modelo.
```{r}
odds_plot(mod_step)
```

###Odds ratio

```{r}
m1 <- glm(mortality > 3 ~ ., data=dat_mort, family = binomial)
summary(m1)
```

```{r}
tab_model(m1)
```

QUEDA RARO ESTE ODDS!!!!!!!!!!!!!!!!!! SON TODOS POSITIVOS QUE ONDA 

```{r}
odds_plot(m1)
```

## Árbol de clasificación

<!-- https://www.displayr.com/how-is-variable-importance-calculated-for-a-random-forest/#:~:text=This%20importance%20is%20a%20measure,accuracy%20due%20to%20random%20noise. -->


```{r}
dtree_quant <- rpart(
  mortality ~ liquid_feeding_volume+hygiene+capacitations+experience, 
  data = dat_mort)
dtree_quant
summary(dtree_quant)
rpart.plot(dtree_quant)
```

Clasifica los casos. 
- las particiones que aparecen arriba son las que capturan mayor variabilidad
- vas particionando en grupos menores, mas chicos, con menos variablidad
- irian en linea con variable importance
La media de mortalidad de todas las encuestas es de 6.3%. Si experiencia es mayor o igual a 3, el promedio de mortalidad es 4.9%, y si a su vez capacitacion es mayor igual a 2, tiene un 3.5% en promedio. A su vex si las practicas de higiene son >=3 la mortalidad se reduce al 2,5%.

- Importancia de las variables predictoras sobre mortalidad

```{r}
data.frame(imp = dtree_quant$variable.importance) %>%
  rownames_to_column("variable") %>% 
  # distinct(variable)
  arrange(imp) %>%
  mutate(variable = fct_inorder(variable)) %>%
  ggplot() +
  aes(x = variable, y = imp) +
  geom_col(width = 0.03) +
  geom_point() +
  coord_flip()
```
<<<<<<< HEAD


## Random forest 

<!-- https://rubenfcasal.github.io/aprendizaje_estadistico/cart-con-el-paquete-rpart.html -->

```{r}
tree_mort <- rpart(mortality ~ ., data = dat_mort)
rpart.plot(tree_mort)  
```

```{r}
rpart.rules(tree_mort, style = "tall")
```

```{r}
importance <- tree_mort$variable.importance # Equivalente a caret::varImp(tree) 
importance <- round(100*importance/sum(importance), 1)
importance
```

```{r}
data.frame(importance = tree_mort$variable.importance) %>%
  rownames_to_column("variable") %>% 
  # distinct(variable)
  arrange(importance) %>%
  mutate(variable = fct_inorder(variable)) %>%
  ggplot() +
  aes(x = variable, y = importance) +
  geom_col(width = 0.03) +
  geom_point() +
  coord_flip()
```


=======
>>>>>>> 90fe7143d9f46f7d506657c2dee969fe14ff9029

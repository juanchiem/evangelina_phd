---
title: "Mortalidad"
format: html
editor: source
editor_options: 
  chunk_output_type: console
---

```{r setup global del informe, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      messages = FALSE
                      )
```

```{r data}
# dat <- rio::import(here::here("survey/survey23.csv"))
dat <- read.csv("https://raw.githubusercontent.com/juanchiem/agro_data/master/survey23.csv", sep = ",") 
```

```{r paquetes, include=FALSE}
pacman::p_load(tidyverse, janitor,  skimr, 
               # GGally, correlation, 
               # performance, 
               scales, 
               # emmeans, multcomp, finalfit,  
               # oddsratio,
               coefplot, 
               OddsPlotty, 
               relaimpo, 
               gtools, 
               sjPlot)
pacman::p_load(rpart, rpart.plot)
conflicted::conflict_prefer("select", "dplyr")
conflicted::conflict_prefer("filter", "dplyr")
```

##  Datos

```{r}
dat_mort <- dat %>% 
  select(-c(feed_cows, milk_yield, scc, afb, ffi, vacination)) %>%
  mutate_at(vars(-(mortality)),as.factor) %>%
  drop_na()  
  # str
dat_mort %>% skim()
hist(dat_mort$mortality) 
```

## Reg. lineal múltiple

```{r}
mod <- lm(mortality ~ ., data= dat_mort)
anova(mod)

mod_step <- stepAIC(mod,  direction="both")
anova(mod_step)
```

```{r}
coefplot(mod_step, intercept = FALSE)
```

En este grafico podemos ver todas las variables que tienen efecto sobre mortalidad la disminuyen, menos vacunacion la cual muestra que al aumentar la vacunacion aumenta la mortalidad. Preguntar a Lu como armo la tabla..

Analizo la importancia relativa de las variables presentes en el modelo

```{r}
ri <- calc.relimp(mod, type="car", rela=TRUE, rank = TRUE)
```

El volumen de dieta liquida explica el 30% de la mortalidad, seguido de capacitaciones con 21% e higiene con 18%

```{r}
dat %>% 
  ggplot() + 
  aes(vacination, mortality) + 
  geom_jitter(width = .1) + 
  geom_smooth()
```

Este ultimo grafico exploratorio muestra que en realidad hay pocos datos para el nivel de vacunacion 1 y a lo mejor ahi esta la explicacion del porque da raro el resultado (>vacunacion>mortalidad)


## Reg log - mort<5

```{r}
mod_bin <- glm(mortality >= 3 ~ ., data=dat_mort)
car::Anova(mod_bin)

mod_step <- stepAIC(mod_bin,  direction="both")
car::Anova(mod_step)

summary(mod_step)
odds_plot(mod_step)
```

Podemos ver en la tabla que se reduce en un 80% (1-0.2) la probabilidad de que la mortalidad sea mayor al 5% cuando el volumen de dieta liquida pasa de 2 a 4 litros y de 4 a 6 litros. (Por cada salto, la probabilidad re reduce un 80%).


## Árbol de clasificación

<!-- https://www.displayr.com/how-is-variable-importance-calculated-for-a-random-forest/#:~:text=This%20importance%20is%20a%20measure,accuracy%20due%20to%20random%20noise. -->


```{r}
dtree_quant <- rpart(
  mortality ~ liquid_feeding_volume+hygiene+capacitations+experience, 
  data = dat_mort)
dtree_quant
summary(dtree_quant)
rpart.plot(dtree_quant)
```

Clasifica los casos. 
- las particiones que aparecen arriba son las que capturan mayor variabilidad
- vas particionando en grupos menores, mas chicos, con menos variablidad
- irian en linea con variable importance
si experiencia es mayor o iguala a 3, el promedio es 8.9, y si a su vez capacitacion es mayor igual a 2, tiene un 10 en promedio

Ayuda a explicar como se relacionan las variables con la mortalidad. Asi, de las encuestas con baja mortalidad un 42% daba alto vol de dieta liquida (>=3 - preguntar a Lu como hizo la clasificacion para interpretar mejor), de ese 42% un 92% tubo baja mortalidad. De los que dieron menor volumen de dieta iquida, cuando realizaron practicas de higiene y capacitacion tuvieron baja mortalidad (25%) y media mortalidad el 19%. Mientras que el 14% restante que alimento con poco volumen y no hizo nada mas (higiene ni capacitacion) tuvo alta mortalidad.

- Importancia de las variables predictoras sobre mortalidad

```{r}
data.frame(imp = dtree_quant$variable.importance) %>%
  rownames_to_column("variable") %>% 
  # distinct(variable)
  arrange(imp) %>%
  mutate(variable = fct_inorder(variable)) %>%
  ggplot() +
  aes(x = variable, y = imp) +
  geom_col(width = 0.03) +
  geom_point() +
  coord_flip()
```
